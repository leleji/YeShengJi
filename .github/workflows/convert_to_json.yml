name: Convert BanAD.list and UnBan.list to JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天运行一次

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Fetch BanAD.list
      run: |
        # 下载 BanAD.list 和 UnBan.list 文件
        curl -s https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list -o BanAD.list
        curl -s https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/UnBan.list -o UnBan.list

    - name: Convert BanAD.list to JSON
      run: |
        # 初始化 BanAD.json 文件
        echo '{
          "rules": [
            {
              "domain_keyword": [],
              "domain_suffix": []
            }
          ]
        }' > BanAD.json

        # 遍历 BanAD.list 并填充 JSON
        while IFS=, read -r type value; do
          # 去掉空行和注释行
          if [[ -z "$type" || "$type" == \#* ]]; then
            continue
          fi

          if [[ "$type" == "DOMAIN-KEYWORD" ]]; then
            # 处理 DOMAIN-KEYWORD 类型
            jq --arg value "$value" '.rules[0].domain_keyword += [$value]' BanAD.json > tmp.json && mv tmp.json BanAD.json
          elif [[ "$type" == "DOMAIN-SUFFIX" ]]; then
            # 处理 DOMAIN-SUFFIX 类型
            jq --arg value "$value" '.rules[0].domain_suffix += [$value]' BanAD.json > tmp.json && mv tmp.json BanAD.json
          fi
        done < BanAD.list

    - name: Convert UnBan.list to JSON
      run: |
        # 初始化 UnBan.json 文件
        echo '{
          "rules": [
            {
              "domain_keyword": [],
              "domain_suffix": []
            }
          ]
        }' > UnBan.json

        # 遍历 UnBan.list 并填充 JSON
        while IFS=, read -r type value; do
          # 去掉空行和注释行
          if [[ -z "$type" || "$type" == \#* ]]; then
            continue
          fi

          if [[ "$type" == "DOMAIN-KEYWORD" ]]; then
            # 处理 DOMAIN-KEYWORD 类型
            jq --arg value "$value" '.rules[0].domain_keyword += [$value]' UnBan.json > tmp.json && mv tmp.json UnBan.json
          elif [[ "$type" == "DOMAIN-SUFFIX" ]]; then
            # 处理 DOMAIN-SUFFIX 类型
            jq --arg value "$value" '.rules[0].domain_suffix += [$value]' UnBan.json > tmp.json && mv tmp.json UnBan.json
          fi
        done < UnBan.list

    - name: Move JSON to Target Directory
      run: |
        # 创建目标目录并移动文件
        mkdir -p singbox/rule/
        mv BanAD.json singbox/rule/BanAD.json
        mv UnBan.json singbox/rule/UnBan.json

    - name: Commit and Push Changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add singbox/rule/BanAD.json singbox/rule/UnBan.json
        git commit -m "Update BanAD.json and UnBan.json with converted rules" || echo "No changes to commit"
        git push
