name: Convert and Update JSON

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # 每天运行一次

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install jq (JSON processor)
      run: sudo apt-get install -y jq

    - name: Fetch and Convert
      run: |
        # 下载 BanAD.list 文件
        curl -s https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanAD.list -o BanAD.list

        # 初始化 JSON 模板
        echo '{
          "rules": [
            {
              "domain_keyword": [],
              "domain_suffix": []
            }
          ]
        }' > aa.json

        # 遍历 BanAD.list 并填充 JSON
        while IFS= read -r line; do
          if [[ "$line" =~ ^\|\| ]]; then
            # 处理 || 开头的行，提取为 domain_suffix
            domain=$(echo "$line" | sed 's/||//;s/\^.*//')
            jq --arg domain "$domain" '.rules[0].domain_suffix += [$domain]' aa.json > tmp.json && mv tmp.json aa.json
          elif [[ "$line" =~ ^@ ]]; then
            # 处理 @ 开头的行，提取为 domain_keyword
            domain=$(echo "$line" | sed 's/@//;s/\^.*//')
            jq --arg domain "$domain" '.rules[0].domain_keyword += [$domain]' aa.json > tmp.json && mv tmp.json aa.json
          fi
        done < BanAD.list

    - name: Move JSON to Target Directory
      run: |
        mkdir -p singbox/rule/
        mv aa.json singbox/rule/aa.json

    - name: Commit and Push Changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add singbox/rule/aa.json BanAD.list # 确保新文件被追踪
        git commit -m "Update aa.json with converted rules" || echo "No changes to commit"
        git push
